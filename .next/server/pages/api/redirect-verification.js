"use strict";(()=>{var e={};e.id=982,e.ids=[982],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},4014:e=>{e.exports=import("iron-session")},6326:e=>{e.exports=import("resend")},6090:e=>{e.exports=import("stripe")},8:(e,t,i)=>{i.a(e,async(e,r)=>{try{i.r(t),i.d(t,{config:()=>u,default:()=>d,routeModule:()=>l});var a=i(1802),o=i(7153),s=i(6249),n=i(3155),c=e([n]);n=(c.then?(await c)():c)[0];let d=(0,s.l)(n,"default"),u=(0,s.l)(n,"config"),l=new a.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/redirect-verification",pathname:"/api/redirect-verification",bundlePath:"",filename:""},userland:n});r()}catch(e){r(e)}})},3155:(e,t,i)=>{i.a(e,async(e,r)=>{try{i.r(t),i.d(t,{default:()=>handler});var a=i(6090),o=i(6326),s=i(6713),n=e([a,o,s]);[a,o,s]=n.then?(await n)():n;let c=new a.default(process.env.STRIPE_SECRET_KEY),d=new o.Resend(process.env.RESEND_API_KEY);async function handler(e,t){try{let{session_id:i,product_name:r}=e.query;if(!i)return t.status(400).send("Missing session_id");if(!r)return t.status(400).send("Missing product_name");let a=await c.checkout.sessions.retrieve(i),o=await c.identity.verificationSessions.create({type:"document",customer:a.customer||void 0,metadata:{email:a.customer_email||a.customer_details?.email,product:r},return_url:"https://stripe-vercel-function.vercel.app/verification-complete"}),n={verificationSessionId:o.id,product:r,email:a.customer_email||a.customer_details?.email,createdAt:Date.now()},u=await (0,s.e)(n);t.setHeader("Set-Cookie",`verification_session=${u}; Path=/; HttpOnly; Secure; SameSite=Lax`),a.customer_details?.email&&await d.emails.send({from:"Get Tax Relief Now <donotreply@updates.gettaxreliefnow.com>",to:a.customer_details.email,subject:`Your Purchase Confirmation: ${r}`,html:`
          <h2>Thank you for your purchase!</h2>
          <p>Product: ${r}</p>
          <p>Amount: ${(a.amount_total/100).toFixed(2)} ${a.currency.toUpperCase()}</p>
          <p>Refunds available within 7 days.</p>
          <p>Please complete your identity verification by clicking below:</p>
          <a href="${o.url}" style="display:inline-block;padding:10px 20px;background:#635bff;color:white;text-decoration:none;border-radius:5px;">
            Start Identity Verification
          </a>
        `}),t.writeHead(302,{Location:o.url}),t.end()}catch(e){console.error("redirect-verification error:",e),t.status(500).json({error:e.message})}}r()}catch(e){r(e)}})}};var t=require("../../webpack-api-runtime.js");t.C(e);var __webpack_exec__=e=>t(t.s=e),i=t.X(0,[222,713],()=>__webpack_exec__(8));module.exports=i})();